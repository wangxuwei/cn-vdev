const router = require('cmdrouter');
const fs = require('fs-extra-plus');
const path = require('path');
const spawn = require('p-spawn');


router.router({ clean }).route();


async function clean(pathDir) {
	const projectPath = pathDir;
	await spawn.spawn("rm", ["-rf", path.join(projectPath, "node_modules")]);
	await spawn.spawn("rm", ["-rf", path.join(projectPath, "package-lock.json")]);

	const servicesPath = path.join(projectPath, "services");
	const files = await fs.readdir(servicesPath);
	for (const dir of files) {
		let fileOrDir = path.join(servicesPath, dir, "node_modules");
		await deleteFile(fileOrDir);

		fileOrDir = path.join(servicesPath, dir, "package-lock.json");
		await deleteFile(fileOrDir);

		fileOrDir = path.join(servicesPath, dir, "dist");
		await deleteFile(fileOrDir);
	}
}

async function deleteFile(pth) {
	if (await fs.pathExists(pth)) {
		await spawn.spawn("rm", ["-rf", pth]);
	}
}